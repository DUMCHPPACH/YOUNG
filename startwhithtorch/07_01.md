# 01. 합성곱과 풀링(Convolution and Pooling)
---
이미지 처리에 탁월한 성능을 보이는 CNN에 대해 알아보자  

합성곱 신경망은 크게 **합성곱층(Convolution layer)** 과 **풀링층(Pooling layer)** 으로 구성 되어있다.  

이미지 처리를 위해서는 앞서 배운 다층 퍼센트론을 사용 할 수 있었지만 한계라 있었다. 예를 들어 손글씨를 분류하는 문제에서 아래 그림처럼 Y를 비교적 정자로 쓴 손글씨와 휘갈겨 쓴 손글씨 두 개를 2차원 텐서 행렬로 표현하면 아래와 같은데   

![image](https://user-images.githubusercontent.com/76423415/133006556-4e61b426-2e7e-46fc-866e-7745db256bc5.png)  

사람이 보기에는 두 그림 모두 쉽게 y로 판단이 가능하지만, 기계가 보기에는 각 픽셀의 값이 다르므로 완전히 다른 값을 가진 입력이 된다. 그런데 이미지라는 것은 위와 같이 같은 대상이더라도 이동되었거나, 방향이 뒤틀렸거나 등 다양한 변형이 존재함. 다층퍼셉트론은 몇 가지 픽셀 값만 달라져도 예측에 민감하게 반응한다는 단점이 있음.  

더 구체적으로 보면 이미지를 다층 퍼셉트론에 입력층으로 사용하기 위해서는 벡터를 (1, n)으로 바꾸어야 하는데 이런 결과는 사람이 보기에도 본래 어떤 이미지인지 판단하기가 어렵다. 이처럼 픽셀은 한줄로 늘이는 변환은 이 전에 갖고 있던 공간적인 구조 정보가 유실된 상태이다.(공간적은 구조란 어떤 가깝고 먼 픽셀들끼리 연관을 갖고 있는 정보). 결국 이미지의 공간적 구조 정보를 보존하면서 학습할 수 있는 방법이 필요해졌고 이를 위해 사용하는 것이 합성곱신경망이다. 

### 채널(channel)
기계는 글자나 이미지보다 숫자. 다시 말해, 텐서를 더 잘 처리 할 수 있다. 이미지는 (높이, 너비, 채널) 이라는 3차원 텐서이다. 채널은 색 성분을 의미하는데 흑백 이미지는 채널 수가 1이며 각 픽셀은 0~255사이의 값을 가진다. 정방향 28사이즈의 흑백 이미지는 (28 × 28 × 1)의 크기를 갖는다.  
RGB는 red, green, blue의 3가지 채널을 갖는다. 정방향 28사이즈의 컬러 이미지는 (28 × 28 × 3)의 크기를 갖는다.  
채널은 때로는 길이(depth)라고도 한다.  

### 합성곱 연산(Convolution Operation)
합성곱 연산을 통해서 이미지의 특징을 추출하는 것  
convolution 은 kernal, filter라는 n×m 크기의 행렬로 높이×너비 크기의 이미지를 처음부터 끝까지 겹치며 훑으면서 n×m 크기의 겹쳐지는 부분의 각 이미지와 **커널의 원소 값** 을 곱해서 모두 더한 값을 출력으로 하는 것을 말한다.  
커널은 주로 3×3 이나 5×5 크기를 사용한다.  
이때 이미지의 가장 왼쪽 위부터 가장 오른쪽 아래까지 순차적으로 훑는다.  
이 여러 연산 중 1번을 스텝(step)이라고 한다.  
여러 스탭을 거치고 나온 최공 결과는 특성맵(feature map)으로 부름.  
다음 스탭으로 옮겨 갈 때 몇 칸 움직일지를 stride로 부름.  

### padding
5×5의 이미지에 3×3 커널로 합성곱 연산을 했을 때 스트라이드가 1일 경우 3×3의 특성맵을 얻을 수 있다. 이렇게 특성맵은 입력의 크기보다 작아진다는 특징이 있다.  
만약 합성곱 층을 여러개 쌓았다면 최종적으로 얻은 특성맵은 초기 입력보다 매우 작은 크기가 될 것임.  
합성곱 연산 이후에도 특성 맵의 크기가 입력의 크기와 동일하게 유지되도록 하고 싶다면 padding을 이용한다. 패딩은 입력의 가장자리에 지정된 개수의 폭만큼 행과 열을 추가해주는 것이다.  
주로 값을 0으로 채우는 제로패딩을 사용한다. 

### 가중치와 편향
합성곱 신경망은 다중 퍼셉트론보다 적은 가중치를 사용하며 입력데이터의 공간 정보를 보존한다.  
예시로 보자  
(3×3) 사이의 이미지를 처리한다고 했을 때
1. 다층퍼셉트론으로 4개의 뉴론을 갖는 은닉층을 추가한다면 3×3을 1차원 텐서로 만들어 9가 되고 9에 4을 추가하여 9×4=36개의 가중치를 갖는다.
2. 합성곱 신경망으로 3×3이미지에 2×2 커널을 사용하고 스트라이드를 1로 지정하면 총 4개의 가중치를 갖는다. 

### 합성공 신경망의 편향
합성곱 신경망에도 편향을 추가 할 수 있다.  
만약 편향을 사용한다면 커널을 적용한 뒤에 더해진다.  
편향을 하나의 값만 존재하며, 커널이 적용된 결과의 모든 원소에 더해진다.  

### 3차원 텐서의 합성곱 연산
지금까지는 채널 또는 깊이를 고려하고 않았다. 다음은 다수의 채널을 가진 이미지에 대한 합성곱 연산에 대해 알아보자.  
만약 다수의 채널을 가진 입력 데이터로 합성곱 연산을 한다고 하면 커널의 개수도 입력의 채널 수만큼 존재해야 한다. 입력 데이터의 채널 수 = 커널 수
그리고 채너 수가 같으으몰 합성곱 연산을 채널마다 수행하여 그 결과를 모두 더하여 최종 feature map을 얻는다. 아래와 같다.  
![image](https://user-images.githubusercontent.com/76423415/133014204-3db3679f-8f74-4272-8161-f605a96efb89.png)  
각 채널에 대한 커널의 크기는 같아야 한다.  
주의할 점은 위에 사용되는 커널은 3개의 커널이 아니라. 3개의 채널을 가진 1개의 커널이라는 점이다.  

### Pooling
일반적으로 합성곱층(합성곱 연산 + 활성활 함수) 다음에는 풀링 층을 추가한다.  
pooling layer에는 특성 맵을 다운 샘플링하여 특성맵의 크기를 줄이는 풀링 연산이 이루어진다.  
풀링 연산에는 일반적으로 최대 풀링(max pooling)과 평균 풀링(average pooling)이 사용된다.
1. 최대 풀링(max pooling): 겹치는 영역 안에서 최대값을 추출하는 방식으로 다운 샘플링
2. 평균 풀링(avg pooling): 평균값을 추출하는 방식으로 다운 샘플링  

풀링을 사용하면 특성 맵의 크기가 줄어드므로 특성 맵의 가중치의 개수가 줄어든다.  


